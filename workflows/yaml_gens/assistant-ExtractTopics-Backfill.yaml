main:
  params:
  - "input"
  steps:
  - segmentsForSession_block:
      steps:
      - segmentsForSession_fetch:
          try:
            steps:
            - segmentsForSession_fetch_call:
                call: "http.post"
                args:
                  url: "${((input.env.BASE_URL + \"/\") + \"firebase/segmentsForSession\")}"
                  body:
                    collection: "${(((\"convo.sessions/\" + input.env.sessionId) + \"/\") + \"messages\")}"
                    windowSeconds: "${default(input.windowSeconds, 1200)}"
                    overlapSeconds: "${default(input.overlapSeconds, 240)}"
                    userId: "${input.env.userId}"
                  auth:
                    type: "OIDC"
                    audience: "${input.env.BASE_URL}"
                  headers:
                    x-user-id: "${input.env.userId}"
                    x-project-id: "${input.env.projectId}"
                result: "segmentsForSession_fetchResult_50dfb871"
          retry: "${http.default_retry}"
      - segmentsForSession_convert:
          steps:
          - segmentsForSession_convert_initResult:
              assign:
              - segmentsForSession_convertResult_51c53d2c: []
          - segmentsForSession_convert_steps:
              for:
                value: "segmentsForSession_convertValue"
                in: "${segmentsForSession_fetchResult_50dfb871.body.segments}"
                steps:
                - segmentsForSession_convert_assignIterResult:
                    assign:
                    - segmentsForSession_convert_assignIterResultVar:
                        sessionId: "${input.env.sessionId}"
                        end: "${segmentsForSession_convertValue.end}"
                        windowSeconds: "${default(input.windowSeconds, 1200)}"
                - segmentsForSession_convert_updateResult:
                    assign:
                    - segmentsForSession_convertResult_51c53d2c: "${list.concat(segmentsForSession_convertResult_51c53d2c, segmentsForSession_convert_assignIterResultVar)}"
  - forEachSegment:
      steps:
      - forEachSegment_initResult:
          assign:
          - forEachSegmentResult_5e7bbe15: []
      - forEachSegment_steps:
          for:
            value: "forEachSegmentValue"
            in: "${segmentsForSession_convertResult_51c53d2c}"
            steps:
            - All_Backfill_run:
                try:
                  steps:
                  - All_Backfill_run_call:
                      call: "googleapis.workflowexecutions.v1.projects.locations.workflows.executions.run"
                      args:
                        workflow_id: "${\"assistant-ExtractTopics-All${WORKFLOW_ENV}\"}"
                        argument:
                          segmentEnd: "${forEachSegmentValue.end}"
                          windowSeconds: "${1200}"
                          overlapSeconds: "${240}"
                          env:
                            userId: "${input.env.userId}"
                            model: "${input.env.model}"
                            callingWorkflowExec: "${default(sys.get_env(\"GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID\"), null)}"
                            BASE_URL: "${input.env.BASE_URL}"
                            background: "${default(map.get(input.env, \"background\"), null)}"
                            projectId: "${input.env.projectId}"
                            sessionId: "${input.env.sessionId}"
                        location: "${sys.get_env(\"GOOGLE_CLOUD_LOCATION\")}"
                        project_id: "${sys.get_env(\"GOOGLE_CLOUD_PROJECT_ID\")}"
                        connector_params:
                          skip_polling: false
                      result: "All_Backfill_runResult_2326c00e"
                retry: "${http.default_retry}"
            - forEachSegment_updateResult:
                assign:
                - forEachSegmentResult_5e7bbe15: "${list.concat(forEachSegmentResult_5e7bbe15, All_Backfill_runResult_2326c00e)}"
  - returnBackfill:
      return: "${forEachSegmentResult_5e7bbe15}"
  - return:
      return: "${forEachSegmentResult_5e7bbe15}"
