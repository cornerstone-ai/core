main:
  params:
  - "input"
  steps:
  - segmentsForSession_block:
      steps:
      - segmentsForSession_fetch:
          try:
            steps:
            - segmentsForSession_fetch_call:
                call: "http.post"
                args:
                  url: "${((input.env.BASE_URL + \"/\") + \"firebase/segmentsForSession\")}"
                  body:
                    collection: "${(((\"convo.sessions/\" + input.arg1) + \"/\") + \"messages\")}"
                    windowSeconds: "${default(input.arg3, 1200)}"
                    overlapSeconds: "${default(input.arg4, 240)}"
                    userId: "${input.env.userId}"
                  auth:
                    type: "OIDC"
                    audience: "${input.env.BASE_URL}"
                  headers:
                    x-user-id: "${input.env.userId}"
                    x-project-id: "${input.env.projectId}"
                result: "segmentsForSession_fetchResult_6b53622e"
          retry: "${http.default_retry}"
      - segmentsForSession_convert:
          steps:
          - segmentsForSession_convert_initResult:
              assign:
              - segmentsForSession_convertResult_40df1c18: []
          - segmentsForSession_convert_steps:
              for:
                value: "segmentsForSession_convertValue"
                in: "${segmentsForSession_fetchResult_6b53622e.body.segments}"
                steps:
                - segmentsForSession_convert_assignIterResult:
                    assign:
                    - segmentsForSession_convert_assignIterResultVar:
                        sessionId: "${input.arg1}"
                        end: "${segmentsForSession_convertValue.end}"
                        windowSeconds: "${default(input.arg3, 1200)}"
                - segmentsForSession_convert_updateResult:
                    assign:
                    - segmentsForSession_convertResult_40df1c18: "${list.concat(segmentsForSession_convertResult_40df1c18, segmentsForSession_convert_assignIterResultVar)}"
  - All_Latest_run:
      try:
        steps:
        - All_Latest_run_call:
            call: "googleapis.workflowexecutions.v1.projects.locations.workflows.executions.run"
            args:
              workflow_id: "${\"assistant-ExtractTopics-All${WORKFLOW_ENV}\"}"
              argument:
                arg1: "${input.arg1}"
                arg2: "${segmentsForSession_convertResult_40df1c18[(len(segmentsForSession_convertResult_40df1c18) - 1)].end}"
                arg3: "${1200}"
                arg4: "${240}"
                env:
                  userId: "${input.env.userId}"
                  model: "${input.env.model}"
                  callingWorkflowExec: "${default(sys.get_env(\"GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID\"), null)}"
                  BASE_URL: "${input.env.BASE_URL}"
                  background: "${default(map.get(input.env, \"background\"), null)}"
                  projectId: "${input.env.projectId}"
                  sessionId: "${input.env.sessionId}"
              location: "${sys.get_env(\"GOOGLE_CLOUD_LOCATION\")}"
              project_id: "${sys.get_env(\"GOOGLE_CLOUD_PROJECT_ID\")}"
              connector_params:
                skip_polling: false
            result: "All_Latest_runResult_5d04ec53"
      retry: "${http.default_retry}"
  - returnLatest:
      return: "${All_Latest_runResult_5d04ec53}"
  - return:
      return: "${All_Latest_runResult_5d04ec53}"
