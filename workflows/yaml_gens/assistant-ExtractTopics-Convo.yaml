main:
  params:
  - "input"
  steps:
  - inSession:
      steps:
      - lock_acquire_try:
          steps:
          - lock_acquire_try_initResult:
              assign:
              - lock_acquire_tryResult_6d0678fc: {}
          - lock_acquire_try_steps:
              try:
                steps:
                - lock_acquire:
                    try:
                      steps:
                      - lock_acquire_call:
                          call: "http.post"
                          args:
                            url: "${((input.env.BASE_URL + \"/\") + \"firebase/locks/acquire\")}"
                            body:
                              collection: "${\"locks.topicInfos.SegKala\"}"
                              id: "${((input.env.sessionId + \":\") + string(input.segmentEnd))}"
                              ttlSeconds: 300
                              owner: "${uuid.generate()}"
                              userId: "${input.env.userId}"
                            auth:
                              type: "OIDC"
                              audience: "${input.env.BASE_URL}"
                            headers:
                              x-user-id: "${input.env.userId}"
                              x-project-id: "${input.env.projectId}"
                          result: "lock_acquireResult_23ebf8e2"
                    retry: "${http.default_retry}"
                - lock_acquire_try_updateResult:
                    assign:
                    - lock_acquire_tryResult_6d0678fc: "${lock_acquireResult_23ebf8e2.body.acquired}"
              except:
                as: "lock_acquire_tryError"
                steps:
                - lock_acquire_err:
                    steps:
                    - lock_acquire_err_initResult:
                        assign:
                        - lock_acquire_errResult_34a448ba: {}
                    - lock_acquire_err_steps:
                        switch:
                        - condition: "${((\"code\" in lock_acquire_tryError) and (lock_acquire_tryError.code == 409))}"
                          steps:
                          - lock_acquire_busy:
                              try:
                                steps:
                                - lock_acquire_busy_call:
                                    call: "sys.log"
                                    args:
                                      text: "${(\"[lock_acquire_busy] \" + \"Lock exists, skipping work.\")}"
                                    result: "lock_acquire_busyResult_37a1f0e"
                              retry: "${http.default_retry}"
                          - lock_acquire_err_updateResult_0:
                              assign:
                              - lock_acquire_errResult_34a448ba: "${false}"
                        - condition: "${true}"
                          steps:
                          - lock_acquire_rethrow:
                              raise: "${lock_acquire_tryError}"
                          - lock_acquire_err_updateResult_1:
                              assign:
                              - lock_acquire_errResult_34a448ba: "${false}"
                - lock_acquire_try_updateResultError:
                    assign:
                    - lock_acquire_tryResult_6d0678fc: "${lock_acquire_errResult_34a448ba}"
      - lock_switch:
          steps:
          - lock_switch_initResult:
              assign:
              - lock_switchResult_73884367: {}
          - lock_switch_steps:
              switch:
              - condition: "${(lock_acquire_tryResult_6d0678fc == true)}"
                steps:
                - work_block:
                    steps:
                    - messages_yoj_block_SegKala:
                        steps:
                        - messages_components_SegKala_1:
                            steps:
                            - messages_components_SegKala_initResult:
                                assign:
                                - messages_components_SegKalaResult_199b06bc: []
                            - messages_components_SegKala_steps:
                                for:
                                  value: "messages_components_SegKalaIdx"
                                  range: "${[0, (1 - 1)]}"
                                  steps:
                                  - messages_components_SegKala_switch:
                                      steps:
                                      - messages_components_SegKala_switch_initResult:
                                          assign:
                                          - messages_components_SegKala_switchResult_41cb83f2: {}
                                      - messages_components_SegKala_switch_steps:
                                          switch:
                                          - condition: "${(messages_components_SegKalaIdx == 0)}"
                                            steps:
                                            - messages_components_SegKala_switch_updateResult_0:
                                                assign:
                                                - messages_components_SegKala_switchResult_41cb83f2:
                                                    kind: "yoj"
                                                    name: "messages"
                                                    framing: ""
                                                    value: "${null}"
                                                    children: []
                                  - messages_components_SegKala_updateResult:
                                      assign:
                                      - messages_components_SegKalaResult_199b06bc: "${list.concat(messages_components_SegKalaResult_199b06bc, messages_components_SegKala_switchResult_41cb83f2)}"
                        - messages_model_SegKala:
                            steps:
                            - messages_model_SegKala_initResult:
                                assign:
                                - messages_model_SegKalaResult_5706ab6e: {}
                            - messages_model_SegKala_steps:
                                try:
                                  steps:
                                  - messages_components_SegKala:
                                      steps:
                                      - messages_components_SegKala_initResult_1:
                                          assign:
                                          - messages_components_SegKalaResult_199b06bc: []
                                      - messages_components_SegKala_steps_1:
                                          for:
                                            value: "messages_components_SegKalaIdx"
                                            range: "${[0, (1 - 1)]}"
                                            steps:
                                            - messages_components_SegKala_switch_1:
                                                steps:
                                                - messages_components_SegKala_switch_initResult_1:
                                                    assign:
                                                    - messages_components_SegKala_switchResult_41cb83f2: {}
                                                - messages_components_SegKala_switch_steps_1:
                                                    switch:
                                                    - condition: "${(messages_components_SegKalaIdx == 0)}"
                                                      steps:
                                                      - messages_components_SegKala_switch_updateResult_0_1:
                                                          assign:
                                                          - messages_components_SegKala_switchResult_41cb83f2:
                                                              kind: "yoj"
                                                              name: "messages"
                                                              framing: ""
                                                              value: "${null}"
                                                              children: []
                                            - messages_components_SegKala_updateResult_1:
                                                assign:
                                                - messages_components_SegKalaResult_199b06bc: "${list.concat(messages_components_SegKalaResult_199b06bc, messages_components_SegKala_switchResult_41cb83f2)}"
                                  - messages_model_SegKala_updateResult:
                                      assign:
                                      - messages_model_SegKalaResult_5706ab6e:
                                          intro: "${null}"
                                          promoteUpstream: false
                                          components: "${messages_components_SegKalaResult_199b06bc}"
                                          filters: "${[]}"
                                except:
                                  as: "messages_model_SegKalaError"
                                  steps:
                                  - messages_model_SegKala_logError:
                                      try:
                                        steps:
                                        - messages_model_SegKala_logError_call:
                                            call: "sys.log"
                                            args:
                                              text: "${(\"[messages_model_SegKala_logError] \" + messages_model_SegKalaError.message)}"
                                            result: "messages_model_SegKala_logErrorResult_138f400f"
                                      retry: "${http.default_retry}"
                                  - messages_model_SegKala_updateResultError:
                                      assign:
                                      - messages_model_SegKalaResult_5706ab6e: "${null}"
                        - TopicContextYoj_run_with_model:
                            try:
                              steps:
                              - TopicContextYoj_run_with_model_call:
                                  call: "http.post"
                                  args:
                                    url: "${((input.env.BASE_URL + \"/\") + \"context/topicContextYoj/run\")}"
                                    body:
                                      kala:
                                        kind: "${\"SegKala\"}"
                                        sessionId: "${input.env.sessionId}"
                                        end: "${input.segmentEnd}"
                                        windowSeconds: "${default(input.windowSeconds, 1200)}"
                                        sessionEnd: "${null}"
                                        weekEnd: "${null}"
                                        begin: "${null}"
                                      presetId: "${null}"
                                      includeDocId: "${true}"
                                      model: "${messages_model_SegKalaResult_5706ab6e}"
                                    auth:
                                      type: "OIDC"
                                      audience: "${input.env.BASE_URL}"
                                    headers:
                                      x-user-id: "${input.env.userId}"
                                      x-project-id: "${input.env.projectId}"
                                  result: "TopicContextYoj_run_with_modelResult_5ad00bda"
                            retry: "${http.default_retry}"
                        - for_messages_items_SegKala:
                            steps:
                            - for_messages_items_SegKala_initResult:
                                assign:
                                - for_messages_items_SegKalaResult_4f553fc4: []
                            - for_messages_items_SegKala_steps:
                                for:
                                  value: "for_messages_items_SegKalaValue"
                                  in: "${TopicContextYoj_run_with_modelResult_5ad00bda.body.yoj}"
                                  steps:
                                  - for_messages_items_SegKala_updateResult:
                                      assign:
                                      - for_messages_items_SegKalaResult_4f553fc4: "${list.concat(for_messages_items_SegKalaResult_4f553fc4, for_messages_items_SegKalaValue)}"
                    - topicInfos_readIstaBlock:
                        steps:
                        - read_topicInfosIsta_logKala:
                            try:
                              steps:
                              - read_topicInfosIsta_logKala_call:
                                  call: "sys.log"
                                  args:
                                    text: "${(\"[read_topicInfosIsta_logKala] \" + (\"SegKala: \" + time.format(input.segmentEnd, \"America/New_York\")))}"
                                  result: "read_topicInfosIsta_logKalaResult_4ae42db4"
                            retry: "${http.default_retry}"
                        - read_topicInfosIsta_convoSegKala:
                            try:
                              steps:
                              - read_topicInfosIsta_convoSegKala_call:
                                  call: "http.post"
                                  args:
                                    url: "${((input.env.BASE_URL + \"/\") + \"firebase/list\")}"
                                    body:
                                      collection: "${(((\"convo.sessions/\" + input.env.sessionId) + \"/\") + \"topicInfos\")}"
                                      start: "${(input.segmentEnd - default(input.windowSeconds, 1200))}"
                                      end: "${input.segmentEnd}"
                                      userId: "${input.env.userId}"
                                    auth:
                                      type: "OIDC"
                                      audience: "${input.env.BASE_URL}"
                                    headers:
                                      x-user-id: "${input.env.userId}"
                                      x-project-id: "${input.env.projectId}"
                                  result: "read_topicInfosIsta_convoSegKalaResult_7b2cfcb9"
                            retry: "${http.default_retry}"
                        - for_topicInfosIsta:
                            steps:
                            - for_topicInfosIsta_initResult:
                                assign:
                                - for_topicInfosIstaResult_345fff4a: []
                            - for_topicInfosIsta_steps:
                                for:
                                  value: "for_topicInfosIstaValue"
                                  in: "${read_topicInfosIsta_convoSegKalaResult_7b2cfcb9.body.documents}"
                                  steps:
                                  - log_topicInfosIsta_read:
                                      try:
                                        steps:
                                        - log_topicInfosIsta_read_call:
                                            call: "sys.log"
                                            args:
                                              text: "${(\"[log_topicInfosIsta_read] \" + (\"Read items: \" + json.encode_to_string(for_topicInfosIstaValue)))}"
                                            result: "log_topicInfosIsta_readResult_65d58f7c"
                                      retry: "${http.default_retry}"
                                  - for_topicInfosIsta_updateResult:
                                      assign:
                                      - for_topicInfosIstaResult_345fff4a: "${list.concat(for_topicInfosIstaResult_345fff4a, for_topicInfosIstaValue.data)}"
                    - ista_write_switch:
                        steps:
                        - ista_write_switch_initResult:
                            assign:
                            - ista_write_switchResult_3671c1c1: {}
                        - ista_write_switch_steps:
                            switch:
                            - condition: "${(((len(for_messages_items_SegKalaResult_4f553fc4) > 0) and ((len(for_topicInfosIstaResult_345fff4a) == 0) or (for_topicInfosIstaResult_345fff4a[(len(for_topicInfosIstaResult_345fff4a) - 1)].create_time < input.segmentEnd))) == true)}"
                              steps:
                              - topicContextYojBlock_SegKala:
                                  steps:
                                  - topicContext_components_SegKala_1:
                                      steps:
                                      - topicContext_components_SegKala_initResult:
                                          assign:
                                          - topicContext_components_SegKalaResult_799d261b: []
                                      - topicContext_components_SegKala_steps:
                                          for:
                                            value: "topicContext_components_SegKalaIdx"
                                            range: "${[0, (1 - 1)]}"
                                            steps:
                                            - topicContext_components_SegKala_switch:
                                                steps:
                                                - topicContext_components_SegKala_switch_initResult:
                                                    assign:
                                                    - topicContext_components_SegKala_switchResult_65aaf8c5: {}
                                                - topicContext_components_SegKala_switch_steps:
                                                    switch:
                                                    - condition: "${(topicContext_components_SegKalaIdx == 0)}"
                                                      steps:
                                                      - topicContext_components_SegKala_switch_updateResult_0:
                                                          assign:
                                                          - topicContext_components_SegKala_switchResult_65aaf8c5:
                                                              kind: "yoj"
                                                              name: "topicContext"
                                                              framing: "${null}"
                                                              value: "${null}"
                                                              children:
                                                              - kind: "yoj"
                                                                name: "topicInfos"
                                                                framing: "Previously extracted topic info:\r"
                                                                value: "${null}"
                                                                children: []
                                                              - kind: "yoj"
                                                                name: "convoContext"
                                                                framing: "${null}"
                                                                value: "${null}"
                                                                children:
                                                                - kind: "yoj"
                                                                  name: "summaries"
                                                                  framing: "Summary of older conversation messages:\r"
                                                                  value: "${null}"
                                                                  children: []
                                                                - kind: "yoj"
                                                                  name: "messages"
                                                                  framing: ""
                                                                  value: "${null}"
                                                                  children: []
                                            - topicContext_components_SegKala_updateResult:
                                                assign:
                                                - topicContext_components_SegKalaResult_799d261b: "${list.concat(topicContext_components_SegKalaResult_799d261b, topicContext_components_SegKala_switchResult_65aaf8c5)}"
                                  - topicContext_model_SegKala:
                                      steps:
                                      - topicContext_model_SegKala_initResult:
                                          assign:
                                          - topicContext_model_SegKalaResult_4e34cfef: {}
                                      - topicContext_model_SegKala_steps:
                                          try:
                                            steps:
                                            - topicContext_components_SegKala:
                                                steps:
                                                - topicContext_components_SegKala_initResult_1:
                                                    assign:
                                                    - topicContext_components_SegKalaResult_799d261b: []
                                                - topicContext_components_SegKala_steps_1:
                                                    for:
                                                      value: "topicContext_components_SegKalaIdx"
                                                      range: "${[0, (1 - 1)]}"
                                                      steps:
                                                      - topicContext_components_SegKala_switch_1:
                                                          steps:
                                                          - topicContext_components_SegKala_switch_initResult_1:
                                                              assign:
                                                              - topicContext_components_SegKala_switchResult_65aaf8c5: {}
                                                          - topicContext_components_SegKala_switch_steps_1:
                                                              switch:
                                                              - condition: "${(topicContext_components_SegKalaIdx == 0)}"
                                                                steps:
                                                                - topicContext_components_SegKala_switch_updateResult_0_1:
                                                                    assign:
                                                                    - topicContext_components_SegKala_switchResult_65aaf8c5:
                                                                        kind: "yoj"
                                                                        name: "topicContext"
                                                                        framing: "${null}"
                                                                        value: "${null}"
                                                                        children:
                                                                        - kind: "yoj"
                                                                          name: "topicInfos"
                                                                          framing: "Previously extracted topic info:\r"
                                                                          value: "${null}"
                                                                          children: []
                                                                        - kind: "yoj"
                                                                          name: "convoContext"
                                                                          framing: "${null}"
                                                                          value: "${null}"
                                                                          children:
                                                                          - kind: "yoj"
                                                                            name: "summaries"
                                                                            framing: "Summary of older conversation messages:\r"
                                                                            value: "${null}"
                                                                            children: []
                                                                          - kind: "yoj"
                                                                            name: "messages"
                                                                            framing: ""
                                                                            value: "${null}"
                                                                            children: []
                                                      - topicContext_components_SegKala_updateResult_1:
                                                          assign:
                                                          - topicContext_components_SegKalaResult_799d261b: "${list.concat(topicContext_components_SegKalaResult_799d261b, topicContext_components_SegKala_switchResult_65aaf8c5)}"
                                            - topicContext_model_SegKala_updateResult:
                                                assign:
                                                - topicContext_model_SegKalaResult_4e34cfef:
                                                    intro:
                                                      system: "These are the previously extracted topic information, as well as the conversation context: "
                                                    promoteUpstream: true
                                                    components: "${topicContext_components_SegKalaResult_799d261b}"
                                                    filters: "${null}"
                                          except:
                                            as: "topicContext_model_SegKalaError"
                                            steps:
                                            - topicContext_model_SegKala_logError:
                                                try:
                                                  steps:
                                                  - topicContext_model_SegKala_logError_call:
                                                      call: "sys.log"
                                                      args:
                                                        text: "${(\"[topicContext_model_SegKala_logError] \" + topicContext_model_SegKalaError.message)}"
                                                      result: "topicContext_model_SegKala_logErrorResult_40d9a46c"
                                                retry: "${http.default_retry}"
                                            - topicContext_model_SegKala_updateResultError:
                                                assign:
                                                - topicContext_model_SegKalaResult_4e34cfef: "${null}"
                                  - TopicContextYoj_run_with_model_1:
                                      try:
                                        steps:
                                        - TopicContextYoj_run_with_model_call_1:
                                            call: "http.post"
                                            args:
                                              url: "${((input.env.BASE_URL + \"/\") + \"context/topicContextYoj/run\")}"
                                              body:
                                                kala:
                                                  kind: "${\"SegKala\"}"
                                                  sessionId: "${input.env.sessionId}"
                                                  end: "${input.segmentEnd}"
                                                  windowSeconds: "${default(input.windowSeconds, 1200)}"
                                                  sessionEnd: "${null}"
                                                  weekEnd: "${null}"
                                                  begin: "${null}"
                                                presetId: "${null}"
                                                includeDocId: "${true}"
                                                model: "${topicContext_model_SegKalaResult_4e34cfef}"
                                              auth:
                                                type: "OIDC"
                                                audience: "${input.env.BASE_URL}"
                                              headers:
                                                x-user-id: "${input.env.userId}"
                                                x-project-id: "${input.env.projectId}"
                                            result: "TopicContextYoj_run_with_modelResult_26d4a349"
                                      retry: "${http.default_retry}"
                                  - for_topicContext_items_SegKala:
                                      steps:
                                      - for_topicContext_items_SegKala_initResult:
                                          assign:
                                          - for_topicContext_items_SegKalaResult_50d40d84: []
                                      - for_topicContext_items_SegKala_steps:
                                          for:
                                            value: "for_topicContext_items_SegKalaValue"
                                            in: "${TopicContextYoj_run_with_modelResult_26d4a349.body.yoj}"
                                            steps:
                                            - for_topicContext_items_SegKala_updateResult:
                                                assign:
                                                - for_topicContext_items_SegKalaResult_50d40d84: "${list.concat(for_topicContext_items_SegKalaResult_50d40d84, for_topicContext_items_SegKalaValue)}"
                              - complete_block:
                                  steps:
                                  - complete_switch:
                                      steps:
                                      - complete_switch_initResult:
                                          assign:
                                          - complete_switchResult_6bc3890b: {}
                                      - complete_switch_steps:
                                          switch:
                                          - condition: "${(len(for_topicContext_items_SegKalaResult_50d40d84) > 0)}"
                                            steps:
                                            - topicInfoIstaBlock:
                                                steps:
                                                - buildTopicIsta:
                                                    steps:
                                                    - buildTopicIsta_initResult:
                                                        assign:
                                                        - buildTopicIstaResult_106d4a6b: []
                                                    - buildTopicIsta_steps:
                                                        for:
                                                          value: "buildTopicIstaIdx"
                                                          range: "${[0, (2 - 1)]}"
                                                          steps:
                                                          - buildTopicIsta_switch:
                                                              steps:
                                                              - buildTopicIsta_switch_initResult:
                                                                  assign:
                                                                  - buildTopicIsta_switchResult_13e8a61a: {}
                                                              - buildTopicIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(buildTopicIstaIdx == 0)}"
                                                                    steps:
                                                                    - buildTopicIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - buildTopicIsta_switchResult_13e8a61a:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Return topics discussed. Typically a conversation will include 1-3 topics. Provide these details about the topics discussed:\n - topic: The name of the topic, keeps names of known topics consistent.\n - breadth: Qualify the breadth of the discussion on this topic in detail.\n - depth: Qualify the depth of the discussion on this topic.\n - startingPoint: Where did the discussion on this topic start? (We want to map the the progression, depth and breadth accross multiple conversations over time)\n - endingPoint: Where did the converstion leave off or conclude?\n - details: Record the relevant details of the discussion on this topic.\n  \"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                                  - condition: "${(buildTopicIstaIdx == 1)}"
                                                                    steps:
                                                                    - buildTopicIsta_switch_updateResult_1:
                                                                        assign:
                                                                        - buildTopicIsta_switchResult_13e8a61a:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Don't repeat information already contained in previous summaries and extracted info.\"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - buildTopicIsta_updateResult:
                                                              assign:
                                                              - buildTopicIstaResult_106d4a6b: "${list.concat(buildTopicIstaResult_106d4a6b, buildTopicIsta_switchResult_13e8a61a)}"
                                                - buildNuggetIsta:
                                                    steps:
                                                    - buildNuggetIsta_initResult:
                                                        assign:
                                                        - buildNuggetIstaResult_6f095387: []
                                                    - buildNuggetIsta_steps:
                                                        for:
                                                          value: "buildNuggetIstaIdx"
                                                          range: "${[0, (1 - 1)]}"
                                                          steps:
                                                          - buildNuggetIsta_switch:
                                                              steps:
                                                              - buildNuggetIsta_switch_initResult:
                                                                  assign:
                                                                  - buildNuggetIsta_switchResult_61ec4514: {}
                                                              - buildNuggetIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(buildNuggetIstaIdx == 0)}"
                                                                    steps:
                                                                    - buildNuggetIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - buildNuggetIsta_switchResult_61ec4514:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Extract key nuggets from the conversation. These are the notable questions/conclusions/learnings that will be most interesting post-conversation when revisting the discussed topics.\nProvide the following field:\n - details: Details of the info nugget.\n  \"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - buildNuggetIsta_updateResult:
                                                              assign:
                                                              - buildNuggetIstaResult_6f095387: "${list.concat(buildNuggetIstaResult_6f095387, buildNuggetIsta_switchResult_61ec4514)}"
                                                - buildRelfectionIsta:
                                                    steps:
                                                    - buildRelfectionIsta_initResult:
                                                        assign:
                                                        - buildRelfectionIstaResult_51210ea: []
                                                    - buildRelfectionIsta_steps:
                                                        for:
                                                          value: "buildRelfectionIstaIdx"
                                                          range: "${[0, (1 - 1)]}"
                                                          steps:
                                                          - buildRelfectionIsta_switch:
                                                              steps:
                                                              - buildRelfectionIsta_switch_initResult:
                                                                  assign:
                                                                  - buildRelfectionIsta_switchResult_3f4527e5: {}
                                                              - buildRelfectionIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(buildRelfectionIstaIdx == 0)}"
                                                                    steps:
                                                                    - buildRelfectionIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - buildRelfectionIsta_switchResult_3f4527e5:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Optionally, provide reflections on your own performance in the converstation. How could you have served the user better?\nAny information about the user or context that would have been useful to have earlier?\nProvide the following field:\n - critique: Details on what you should have done differently or known beforehand.\n  \"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - buildRelfectionIsta_updateResult:
                                                              assign:
                                                              - buildRelfectionIstaResult_51210ea: "${list.concat(buildRelfectionIstaResult_51210ea, buildRelfectionIsta_switchResult_3f4527e5)}"
                                                - buildArtifactIsta:
                                                    steps:
                                                    - buildArtifactIsta_initResult:
                                                        assign:
                                                        - buildArtifactIstaResult_663bbd5f: []
                                                    - buildArtifactIsta_steps:
                                                        for:
                                                          value: "buildArtifactIstaIdx"
                                                          range: "${[0, (1 - 1)]}"
                                                          steps:
                                                          - buildArtifactIsta_switch:
                                                              steps:
                                                              - buildArtifactIsta_switch_initResult:
                                                                  assign:
                                                                  - buildArtifactIsta_switchResult_1e7253b2: {}
                                                              - buildArtifactIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(buildArtifactIstaIdx == 0)}"
                                                                    steps:
                                                                    - buildArtifactIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - buildArtifactIsta_switchResult_1e7253b2:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Extract all important artifacts (documents, snippets, etc.) from the conversation.\nThese are often the most important information in a convo because they serve as the concrete elements that give a convo it's value.\nProvide the following fields for each artifact:\n - name: Name of the artifact (identifier).\n - path: (If saved file) This should be the path and filename for actual files.\n - Type of the artifact (informs how to use or interpret)\n - contents: (Only if not a saved file) Contents of the artifact.\n - description: Context for the artifact and any important info that needs to accompany it.\n  \"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - buildArtifactIsta_updateResult:
                                                              assign:
                                                              - buildArtifactIstaResult_663bbd5f: "${list.concat(buildArtifactIstaResult_663bbd5f, buildArtifactIsta_switchResult_1e7253b2)}"
                                                - buildTopicInfoIsta:
                                                    steps:
                                                    - buildTopicInfoIsta_initResult:
                                                        assign:
                                                        - buildTopicInfoIstaResult_57e32bcf: []
                                                    - buildTopicInfoIsta_steps:
                                                        for:
                                                          value: "buildTopicInfoIstaIdx"
                                                          range: "${[0, (1 - 1)]}"
                                                          steps:
                                                          - buildTopicInfoIsta_switch:
                                                              steps:
                                                              - buildTopicInfoIsta_switch_initResult:
                                                                  assign:
                                                                  - buildTopicInfoIsta_switchResult_5436b49a: {}
                                                              - buildTopicInfoIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(buildTopicInfoIstaIdx == 0)}"
                                                                    steps:
                                                                    - buildTopicInfoIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - buildTopicInfoIsta_switchResult_5436b49a:
                                                                            role: "${\"system\"}"
                                                                            content: "${\"Please extract topic information from the conversation. The idea is to distil important information/conclusions/results from the convo that can then be used to build a system representing the user's preferences, progression and overall goals.\nExtract the following types of information:\n - topics: Topics discussed.\n - nuggets: Usefull nuggets of information to retain.\n - reflections: Stear your own behavior onto a better heading.\n - artifacts: Important data chunks to retain.\n - shouldSaveReflection: Should we update AGENT.md (or similiar) to better stear futher operations? Can we improve general instructions by adding widely applicable information? Use sparingly so we don't polute our agent files. (boolean)\n        \"}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - buildTopicInfoIsta_updateResult:
                                                              assign:
                                                              - buildTopicInfoIstaResult_57e32bcf: "${list.concat(buildTopicInfoIstaResult_57e32bcf, buildTopicInfoIsta_switchResult_5436b49a)}"
                                                - joinTopicInfoIsta:
                                                    steps:
                                                    - joinTopicInfoIsta_initResult:
                                                        assign:
                                                        - joinTopicInfoIstaResult_44f94607: []
                                                    - joinTopicInfoIsta_steps:
                                                        for:
                                                          value: "joinTopicInfoIstaIdx"
                                                          range: "${[0, ((((((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)) + len(buildRelfectionIstaResult_51210ea)) + len(buildArtifactIstaResult_663bbd5f)) + len(buildTopicInfoIstaResult_57e32bcf)) - 1)]}"
                                                          steps:
                                                          - joinTopicInfoIsta_switch:
                                                              steps:
                                                              - joinTopicInfoIsta_switch_initResult:
                                                                  assign:
                                                                  - joinTopicInfoIsta_switchResult_3d61630c: {}
                                                              - joinTopicInfoIsta_switch_steps:
                                                                  switch:
                                                                  - condition: "${(joinTopicInfoIstaIdx >= ((((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)) + len(buildRelfectionIstaResult_51210ea)) + len(buildArtifactIstaResult_663bbd5f)))}"
                                                                    steps:
                                                                    - joinTopicInfoIsta_switch_updateResult_0:
                                                                        assign:
                                                                        - joinTopicInfoIsta_switchResult_3d61630c: "${buildTopicInfoIstaResult_57e32bcf[(joinTopicInfoIstaIdx - ((((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)) + len(buildRelfectionIstaResult_51210ea)) + len(buildArtifactIstaResult_663bbd5f)))]}"
                                                                  - condition: "${(joinTopicInfoIstaIdx >= (((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)) + len(buildRelfectionIstaResult_51210ea)))}"
                                                                    steps:
                                                                    - joinTopicInfoIsta_switch_updateResult_1:
                                                                        assign:
                                                                        - joinTopicInfoIsta_switchResult_3d61630c: "${buildArtifactIstaResult_663bbd5f[(joinTopicInfoIstaIdx - (((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)) + len(buildRelfectionIstaResult_51210ea)))]}"
                                                                  - condition: "${(joinTopicInfoIstaIdx >= ((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)))}"
                                                                    steps:
                                                                    - joinTopicInfoIsta_switch_updateResult_2:
                                                                        assign:
                                                                        - joinTopicInfoIsta_switchResult_3d61630c: "${buildRelfectionIstaResult_51210ea[(joinTopicInfoIstaIdx - ((0 + len(buildTopicIstaResult_106d4a6b)) + len(buildNuggetIstaResult_6f095387)))]}"
                                                                  - condition: "${(joinTopicInfoIstaIdx >= (0 + len(buildTopicIstaResult_106d4a6b)))}"
                                                                    steps:
                                                                    - joinTopicInfoIsta_switch_updateResult_3:
                                                                        assign:
                                                                        - joinTopicInfoIsta_switchResult_3d61630c: "${buildNuggetIstaResult_6f095387[(joinTopicInfoIstaIdx - (0 + len(buildTopicIstaResult_106d4a6b)))]}"
                                                                  - condition: "${(joinTopicInfoIstaIdx >= 0)}"
                                                                    steps:
                                                                    - joinTopicInfoIsta_switch_updateResult_4:
                                                                        assign:
                                                                        - joinTopicInfoIsta_switchResult_3d61630c: "${buildTopicIstaResult_106d4a6b[(joinTopicInfoIstaIdx - 0)]}"
                                                          - joinTopicInfoIsta_updateResult:
                                                              assign:
                                                              - joinTopicInfoIstaResult_44f94607: "${list.concat(joinTopicInfoIstaResult_44f94607, joinTopicInfoIsta_switchResult_3d61630c)}"
                                            - buildPrompt:
                                                steps:
                                                - buildPrompt_initResult:
                                                    assign:
                                                    - buildPromptResult_59df78dc: []
                                                - buildPrompt_steps:
                                                    for:
                                                      value: "buildPromptIdx"
                                                      range: "${[0, (1 - 1)]}"
                                                      steps:
                                                      - buildPrompt_switch:
                                                          steps:
                                                          - buildPrompt_switch_initResult:
                                                              assign:
                                                              - buildPrompt_switchResult_58acc703: {}
                                                          - buildPrompt_switch_steps:
                                                              switch:
                                                              - condition: "${(buildPromptIdx == 0)}"
                                                                steps:
                                                                - buildPrompt_switch_updateResult_0:
                                                                    assign:
                                                                    - buildPrompt_switchResult_58acc703:
                                                                        role: "${\"system\"}"
                                                                        content: "${\"You're a background assistant, scrutanizing live or recorded conversations. You're the 'unconsciouse' part of the conversation agent, adding depth and structured memory to the conversation.\"}"
                                                                        tool_calls: "${[]}"
                                                                        tool_call_id: "${null}"
                                                                        create_time: "${sys.now()}"
                                                                        docId: "${null}"
                                                      - buildPrompt_updateResult:
                                                          assign:
                                                          - buildPromptResult_59df78dc: "${list.concat(buildPromptResult_59df78dc, buildPrompt_switchResult_58acc703)}"
                                            - complete_joinMessages:
                                                steps:
                                                - complete_joinMessages_initResult:
                                                    assign:
                                                    - complete_joinMessagesResult_4e210caf: []
                                                - complete_joinMessages_steps:
                                                    for:
                                                      value: "complete_joinMessagesIdx"
                                                      range: "${[0, ((((0 + len(buildPromptResult_59df78dc)) + len(for_topicContext_items_SegKalaResult_50d40d84)) + len(joinTopicInfoIstaResult_44f94607)) - 1)]}"
                                                      steps:
                                                      - complete_joinMessages_switch:
                                                          steps:
                                                          - complete_joinMessages_switch_initResult:
                                                              assign:
                                                              - complete_joinMessages_switchResult_455625c1: {}
                                                          - complete_joinMessages_switch_steps:
                                                              switch:
                                                              - condition: "${(complete_joinMessagesIdx >= ((0 + len(buildPromptResult_59df78dc)) + len(for_topicContext_items_SegKalaResult_50d40d84)))}"
                                                                steps:
                                                                - complete_joinMessages_switch_updateResult_0:
                                                                    assign:
                                                                    - complete_joinMessages_switchResult_455625c1: "${joinTopicInfoIstaResult_44f94607[(complete_joinMessagesIdx - ((0 + len(buildPromptResult_59df78dc)) + len(for_topicContext_items_SegKalaResult_50d40d84)))]}"
                                                              - condition: "${(complete_joinMessagesIdx >= (0 + len(buildPromptResult_59df78dc)))}"
                                                                steps:
                                                                - complete_joinMessages_switch_updateResult_1:
                                                                    assign:
                                                                    - complete_joinMessages_switchResult_455625c1: "${for_topicContext_items_SegKalaResult_50d40d84[(complete_joinMessagesIdx - (0 + len(buildPromptResult_59df78dc)))]}"
                                                              - condition: "${(complete_joinMessagesIdx >= 0)}"
                                                                steps:
                                                                - complete_joinMessages_switch_updateResult_2:
                                                                    assign:
                                                                    - complete_joinMessages_switchResult_455625c1: "${buildPromptResult_59df78dc[(complete_joinMessagesIdx - 0)]}"
                                                      - complete_joinMessages_updateResult:
                                                          assign:
                                                          - complete_joinMessagesResult_4e210caf: "${list.concat(complete_joinMessagesResult_4e210caf, complete_joinMessages_switchResult_455625c1)}"
                                            - complete_chat_block:
                                                steps:
                                                - spec:
                                                    steps:
                                                    - spec_initResult:
                                                        assign:
                                                        - specResult_2a1c55d: {}
                                                    - spec_steps:
                                                        try:
                                                          steps:
                                                          - spec_updateResult:
                                                              assign:
                                                              - specResult_2a1c55d: "${{\n  \"topics\" : \"${example.topics}\",\n  \"nuggets\" : \"${example.nuggets}\",\n  \"reflections\" : \"${example.reflections}\",\n  \"artifacts\" : \"${example.artifacts}\",\n  \"shouldSaveReflection\" : \"${example.shouldSaveReflection}\"\n}}"
                                                        except:
                                                          as: "specError"
                                                          steps:
                                                          - spec_logError:
                                                              try:
                                                                steps:
                                                                - spec_logError_call:
                                                                    call: "sys.log"
                                                                    args:
                                                                      text: "${(\"[spec_logError] \" + specError.message)}"
                                                                    result: "spec_logErrorResult_6261db2d"
                                                              retry: "${http.default_retry}"
                                                          - spec_updateResultError:
                                                              assign:
                                                              - specResult_2a1c55d: "${null}"
                                                - complete_chat_buildSchemaList:
                                                    steps:
                                                    - complete_chat_buildSchemaList_initResult:
                                                        assign:
                                                        - complete_chat_buildSchemaListResult_69f48bbc: []
                                                    - complete_chat_buildSchemaList_steps:
                                                        for:
                                                          value: "complete_chat_buildSchemaListIdx"
                                                          range: "${[0, (1 - 1)]}"
                                                          steps:
                                                          - complete_chat_buildSchemaList_switch:
                                                              steps:
                                                              - complete_chat_buildSchemaList_switch_initResult:
                                                                  assign:
                                                                  - complete_chat_buildSchemaList_switchResult_45f52704: {}
                                                              - complete_chat_buildSchemaList_switch_steps:
                                                                  switch:
                                                                  - condition: "${(complete_chat_buildSchemaListIdx == 0)}"
                                                                    steps:
                                                                    - complete_chat_buildSchemaList_switch_updateResult_0:
                                                                        assign:
                                                                        - complete_chat_buildSchemaList_switchResult_45f52704:
                                                                            role: "${\"system\"}"
                                                                            content: "${(\"Respond with a JSON in this format:\r\" + specResult_2a1c55d)}"
                                                                            tool_calls: "${[]}"
                                                                            tool_call_id: "${null}"
                                                                            create_time: "${sys.now()}"
                                                                            docId: "${null}"
                                                          - complete_chat_buildSchemaList_updateResult:
                                                              assign:
                                                              - complete_chat_buildSchemaListResult_69f48bbc: "${list.concat(complete_chat_buildSchemaListResult_69f48bbc, complete_chat_buildSchemaList_switchResult_45f52704)}"
                                                - complete_chat_post:
                                                    try:
                                                      steps:
                                                      - complete_chat_post_call:
                                                          call: "http.post"
                                                          args:
                                                            url: "${((input.env.BASE_URL + \"/\") + \"llm/chat\")}"
                                                            body:
                                                              messages: "${list.concat(complete_joinMessagesResult_4e210caf, complete_chat_buildSchemaListResult_69f48bbc[0])}"
                                                              model: "${\"gpt-5\"}"
                                                              temperature: 0.8
                                                              max_completion_tokens: "${null}"
                                                              response_format:
                                                                type: "json_object"
                                                              tools: "${[]}"
                                                              tool_choice: "${\"auto\"}"
                                                            auth:
                                                              type: "OIDC"
                                                              audience: "${input.env.BASE_URL}"
                                                            headers:
                                                              x-user-id: "${input.env.userId}"
                                                              x-project-id: "${input.env.projectId}"
                                                          result: "complete_chat_postResult_7765b296"
                                                    retry: "${http.default_retry}"
                                                - decoded:
                                                    steps:
                                                    - decoded_initResult:
                                                        assign:
                                                        - decodedResult_1e7a6de0: {}
                                                    - decoded_steps:
                                                        try:
                                                          steps:
                                                          - decoded_updateResult:
                                                              assign:
                                                              - decodedResult_1e7a6de0:
                                                                  result: "${json.decode(complete_chat_postResult_7765b296.body.message.content)}"
                                                                  total_cost: "${complete_chat_postResult_7765b296.body.total_cost}"
                                                        except:
                                                          as: "decodedError"
                                                          steps:
                                                          - decoded_logError:
                                                              try:
                                                                steps:
                                                                - decoded_logError_call:
                                                                    call: "sys.log"
                                                                    args:
                                                                      text: "${(\"[decoded_logError] \" + decodedError.message)}"
                                                                    result: "decoded_logErrorResult_1b2bbd0f"
                                                              retry: "${http.default_retry}"
                                                          - decoded_updateResultError:
                                                              assign:
                                                              - decodedResult_1e7a6de0: "${null}"
                                            - complete_switch_updateResult_0:
                                                assign:
                                                - complete_switchResult_6bc3890b: "${decodedResult_1e7a6de0}"
                                          - condition: "${true}"
                                            steps:
                                            - emptyYoj:
                                                raise:
                                                  message: "${\"Empty Yoj returned\"}"
                                                  code: "${400}"
                                            - complete_switch_updateResult_1:
                                                assign:
                                                - complete_switchResult_6bc3890b: "${null}"
                              - do_write_seg_block:
                                  steps:
                                  - ista_write_newId:
                                      steps:
                                      - ista_write_newId_initResult:
                                          assign:
                                          - ista_write_newIdResult_506281f1: {}
                                      - ista_write_newId_steps:
                                          try:
                                            steps:
                                            - ista_write_newId_updateResult:
                                                assign:
                                                - ista_write_newIdResult_506281f1: "${uuid.generate()}"
                                          except:
                                            as: "ista_write_newIdError"
                                            steps:
                                            - ista_write_newId_logError:
                                                try:
                                                  steps:
                                                  - ista_write_newId_logError_call:
                                                      call: "sys.log"
                                                      args:
                                                        text: "${(\"[ista_write_newId_logError] \" + ista_write_newIdError.message)}"
                                                      result: "ista_write_newId_logErrorResult_60a9514f"
                                                retry: "${http.default_retry}"
                                            - ista_write_newId_updateResultError:
                                                assign:
                                                - ista_write_newIdResult_506281f1: "${null}"
                                  - ista_write_create_child:
                                      try:
                                        steps:
                                        - ista_write_create_child_call:
                                            call: "http.post"
                                            args:
                                              url: "${((input.env.BASE_URL + \"/\") + \"firebase/create\")}"
                                              body:
                                                collection: "${(((\"convo.sessions/\" + input.env.sessionId) + \"/\") + \"topicInfos\")}"
                                                id: "${ista_write_newIdResult_506281f1}"
                                                contents:
                                                  value: "${complete_switchResult_6bc3890b.result}"
                                                  create_time: "${input.segmentEnd}"
                                                  cost: "${complete_switchResult_6bc3890b.total_cost}"
                                                  execId: "${sys.get_env(\"GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID\")}"
                                                userId: "${input.env.userId}"
                                              auth:
                                                type: "OIDC"
                                                audience: "${input.env.BASE_URL}"
                                              headers:
                                                x-user-id: "${input.env.userId}"
                                                x-project-id: "${input.env.projectId}"
                                            result: "ista_write_create_childResult_1c955d83"
                                      retry: "${http.default_retry}"
                                  - ista_write_update_parent_update_time:
                                      try:
                                        steps:
                                        - ista_write_update_parent_update_time_call:
                                            call: "http.post"
                                            args:
                                              url: "${((input.env.BASE_URL + \"/\") + \"firebase/update\")}"
                                              body:
                                                collection: "${\"convo.sessions\"}"
                                                id: "${input.env.sessionId}"
                                                contents:
                                                  update_time: "${input.segmentEnd}"
                                                userId: "${input.env.userId}"
                                              auth:
                                                type: "OIDC"
                                                audience: "${input.env.BASE_URL}"
                                              headers:
                                                x-user-id: "${input.env.userId}"
                                                x-project-id: "${input.env.projectId}"
                                            result: "ista_write_update_parent_update_timeResult_11f3c15c"
                                      retry: "${http.default_retry}"
                                  - post_write_block:
                                      steps: []
                              - ista_write_switch_updateResult_0:
                                  assign:
                                  - ista_write_switchResult_3671c1c1: "${complete_switchResult_6bc3890b.result}"
                            - condition: "${true}"
                              steps:
                              - write_skipped:
                                  try:
                                    steps:
                                    - write_skipped_call:
                                        call: "sys.log"
                                        args:
                                          text: "${(\"[write_skipped] \" + \"Summary already exists or no messages. Skipping write.\")}"
                                        result: "write_skippedResult_7dea72e7"
                                  retry: "${http.default_retry}"
                              - ista_write_switch_updateResult_1:
                                  assign:
                                  - ista_write_switchResult_3671c1c1: "${null}"
                - lock_release:
                    try:
                      steps:
                      - lock_release_call:
                          call: "http.post"
                          args:
                            url: "${((input.env.BASE_URL + \"/\") + \"firebase/locks/release\")}"
                            body:
                              collection: "${\"locks.topicInfos.SegKala\"}"
                              id: "${((input.env.sessionId + \":\") + string(input.segmentEnd))}"
                              owner: "${uuid.generate()}"
                              userId: "${input.env.userId}"
                            auth:
                              type: "OIDC"
                              audience: "${input.env.BASE_URL}"
                            headers:
                              x-user-id: "${input.env.userId}"
                              x-project-id: "${input.env.projectId}"
                          result: "lock_releaseResult_3eb74dc1"
                    retry: "${http.default_retry}"
                - lock_switch_updateResult_0:
                    assign:
                    - lock_switchResult_73884367: "${ista_write_switchResult_3671c1c1}"
              - condition: "${true}"
                steps:
                - lock_switch_updateResult_1:
                    assign:
                    - lock_switchResult_73884367: "${null}"
  - return:
      return: "${lock_switchResult_73884367}"
